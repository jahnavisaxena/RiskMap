<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiskMap - GRC Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="header-left">
                <div class="logo-section">
                    <span class="logo-icon">üõ°Ô∏è</span>
                    <div class="logo-text">
                        <h1>RiskMap</h1>
                        <p class="subtitle">GRC Risk Management Dashboard</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="header-info">
                    <span class="header-date" id="current-date"></span>
                    <button class="theme-toggle" id="theme-toggle" title="Toggle Dark Mode">
                        <span class="theme-icon-light">‚òÄÔ∏è</span>
                        <span class="theme-icon-dark">üåô</span>
                    </button>
                    <span class="header-badge">Enterprise Edition</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- SOC 2 specific Dashboard -->
        <section class="dashboard-section">
            <!-- Audit Type Selector Widget -->
            <div class="audit-type-widget">
                <div class="audit-header">
                    <h3>SOC 2 Audit Scope</h3>
                    <div class="audit-toggle-group">
                        <input type="radio" id="type1" name="audit-type" value="type1" checked
                            onchange="toggleAuditType('type1')">
                        <label for="type1">Type 1 (Point-in-Time)</label>

                        <input type="radio" id="type2" name="audit-type" value="type2"
                            onchange="toggleAuditType('type2')">
                        <label for="type2">Type 2 (Period of Time)</label>
                    </div>
                </div>
                <div class="audit-info">
                    <p id="audit-desc-type1" class="audit-desc active">Evaluates the design of controls at a specific
                        point in time. Focuses on suitability of design.</p>
                    <p id="audit-desc-type2" class="audit-desc">Evaluates the design and operating effectiveness of
                        controls over a period (e.g., 6 months).</p>
                </div>
            </div>

            <!-- Evidence & Readiness Grid -->
            <div class="soc2-grid">
                <!-- Readiness Checklist -->
                <div class="readiness-panel">
                    <div class="panel-header">
                        <h3>‚úÖ Readiness Checklist</h3>
                        <span id="readiness-progress" class="badge-audit">0% Ready</span>
                    </div>
                    <div class="checklist-container" id="checklist-container">
                        <!-- Populated by JS based on Type 1 / Type 2 -->
                    </div>
                </div>

                <!-- Evidence Required Panel -->
                <div class="evidence-panel">
                    <div class="panel-header">
                        <h3>üìÇ Evidence Required</h3>
                        <span class="badg-evidence" id="evidence-badge">Snapshot</span>
                    </div>
                    <ul class="evidence-list" id="evidence-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Risks by Trust Service Criteria</h3>
                    <div class="canvas-wrapper">
                        <canvas id="tscChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Control Gap Analysis</h3>
                    <div class="canvas-wrapper">
                        <canvas id="gapChart"></canvas>
                    </div>
                </div>
                <div class="top-risks-container">
                    <h3>üö® Top SOC 2 Risks</h3>
                    <div id="top-risks-list" class="top-risks-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Risk Heat Map -->
        <section class="heat-map-section">
            <div class="heat-map-header">
                <h2>Risk Heat Map</h2>
                <div class="heat-map-legend">
                    <span class="legend-item"><span class="legend-color critical-zone"></span> Critical (20-25)</span>
                    <span class="legend-item"><span class="legend-color high-zone"></span> High (15-19)</span>
                    <span class="legend-item"><span class="legend-color medium-zone"></span> Medium (10-14)</span>
                    <span class="legend-item"><span class="legend-color low-zone"></span> Low (1-9)</span>
                </div>
            </div>

            <div class="heat-map-container">
                <div class="heat-map-grid-wrapper">
                    <div class="y-axis-label">Likelihood</div>
                    <div class="y-axis">
                        <div class="axis-tick">5</div>
                        <div class="axis-tick">4</div>
                        <div class="axis-tick">3</div>
                        <div class="axis-tick">2</div>
                        <div class="axis-tick">1</div>
                    </div>

                    <div class="heat-map-grid" id="heat-map-grid">
                        <!-- Grid cells will be generated by JavaScript -->
                    </div>
                </div>

                <div class="x-axis">
                    <div class="axis-tick">1</div>
                    <div class="axis-tick">2</div>
                    <div class="axis-tick">3</div>
                    <div class="axis-tick">4</div>
                    <div class="axis-tick">5</div>
                </div>
                <div class="x-axis-label">Impact</div>
            </div>
        </section>
        <tbody id="risk-table-body">
            <tr>
                <td colspan="9" class="no-data">No risks found. Click "Add Risk" to get started.</td>
            </tr>
        </tbody>
        </table>
        </div>
        </section>
    </main>

    <!-- Add/Edit Risk Modal -->
    <div id="risk-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Risk</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="risk-form" onsubmit="saveRisk(event)">
                <input type="hidden" id="risk-id">

                <div class="form-group">
                    <label for="risk-name">Risk Name *</label>
                    <input type="text" id="risk-name" required placeholder="e.g., Data Breach">
                </div>

                <div class="form-group">
                    <label for="risk-description">Description</label>
                    <textarea id="risk-description" rows="3" placeholder="Detailed description of the risk"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-likelihood">Likelihood (1-5) *</label>
                        <input type="number" id="risk-likelihood" min="1" max="5" required value="3">
                    </div>

                    <div class="form-group">
                        <label for="risk-impact">Impact (1-5) *</label>
                        <input type="number" id="risk-impact" min="1" max="5" required value="3">
                    </div>
                </div>

                <div class="form-group">
                    <input type="hidden" id="risk-framework" value="soc2">
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-primary);">Risk Treatment &
                    Remediation</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-treatment">Treatment Strategy</label>
                        <select id="risk-treatment">
                            <option value="Mitigate">Mitigate</option>
                            <option value="Accept">Accept</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Avoid">Avoid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="risk-status">Status</label>
                        <select id="risk-status">
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Mitigated">Mitigated</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="risk-action-items">Action Items</label>
                    <textarea id="risk-action-items" rows="2"
                        placeholder="Specific steps to address this risk"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-owner">Owner</label>
                        <input type="text" id="risk-owner" placeholder="Person/team responsible">
                    </div>

                    <div class="form-group">
                        <label for="risk-due-date">Due Date</label>
                        <input type="date" id="risk-due-date">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Risk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Update current date in header
        function updateDate() {
            const dateEl = document.getElementById('current-date');
            if (dateEl) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateEl.textContent = new Date().toLocaleDateString('en-US', options);
            }
        }
        updateDate();

        // Dark Mode Toggle
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme') || 'light';

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }
        initTheme();
    </script>
</body>

</html>