<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiskMap - GRC Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="header-left">
                <div class="logo-section">
                    <span class="logo-icon">üõ°Ô∏è</span>
                    <div class="logo-text">
                        <h1>RiskMap</h1>
                        <p class="subtitle">GRC Risk Management Dashboard</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="header-info">
                    <span class="header-date" id="current-date"></span>
                    <button class="theme-toggle" id="theme-toggle" title="Toggle Dark Mode">
                        <span class="theme-icon-light">‚òÄÔ∏è</span>
                        <span class="theme-icon-dark">üåô</span>
                    </button>
                    <span class="header-badge">Enterprise Edition</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- SOC 2 specific Dashboard -->
        <section class="dashboard-section">
            <!-- Key Metrics Grid -->
            <div class="metrics-grid">
                <div class="stat-card stat-total">
                    <div class="stat-number" id="total-risks">0</div>
                    <div class="stat-label">Total Risks</div>
                </div>
                <div class="stat-card stat-critical">
                    <div class="stat-number" id="critical-risks">0</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-card stat-high">
                    <div class="stat-number" id="high-risks">0</div>
                    <div class="stat-label">High</div>
                </div>
                <div class="stat-card stat-medium">
                    <div class="stat-number" id="medium-risks">0</div>
                    <div class="stat-label">Medium</div>
                </div>
                <div class="stat-card stat-low">
                    <div class="stat-number" id="low-risks">0</div>
                    <div class="stat-label">Low</div>
                </div>
            </div>

            <!-- Audit Type Selector Widget -->
            <div class="audit-type-widget">
                <div class="audit-header">
                    <h3>SOC 2 Audit Scope</h3>
                    <div class="audit-toggle-group">
                        <span class="radio-item">
                            <input type="radio" id="type1" name="audit-type" value="type1" checked
                                onchange="toggleAuditType('type1')">
                            <label for="type1">Type 1</label>
                        </span>

                        <span class="radio-item">
                            <input type="radio" id="type2" name="audit-type" value="type2"
                                onchange="toggleAuditType('type2')">
                            <label for="type2">Type 2</label>
                        </span>
                    </div>
                </div>
                <div class="audit-info">
                    <p id="audit-desc-type1" class="audit-desc active">Evaluates the design of controls at a specific
                        point in time. Focuses on suitability of design.</p>
                    <p id="audit-desc-type2" class="audit-desc">Evaluates the design and operating effectiveness of
                        controls over a period (e.g., 6 months).</p>
                </div>
            </div>

            <!-- Evidence & Readiness Grid -->
            <div class="soc2-grid">
                <!-- Readiness Checklist -->
                <div class="readiness-panel">
                    <div class="panel-header">
                        <h3>‚úÖ Readiness Checklist</h3>
                        <span id="readiness-progress" class="badge-audit">0% Ready</span>
                    </div>
                    <div class="checklist-container" id="checklist-container">
                        <!-- Populated by JS based on Type 1 / Type 2 -->
                    </div>
                </div>

                <!-- Evidence Required Panel -->
                <div class="evidence-panel">
                    <div class="panel-header">
                        <h3>üìÇ Evidence Required</h3>
                        <span class="badg-evidence" id="evidence-badge">Snapshot</span>
                    </div>
                    <ul class="evidence-list" id="evidence-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>

            <!-- Comprehensive SOC 2 Charts Grid -->
            <div class="charts-grid-analytics">
                <!-- 1. Risk Severity Donut -->
                <div class="chart-card">
                    <h3>Risk Severity</h3>
                    <div class="canvas-wrapper">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>

                <!-- 2. Risk Status Donut -->
                <div class="chart-card">
                    <h3>Risk Status</h3>
                    <div class="canvas-wrapper">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- 3. Risk Heat Map (Re-implemented) -->
                <div class="chart-card heatmap-card">
                    <h3>Risk Heat Map</h3>
                    <div class="canvas-wrapper">
                        <canvas id="heatmapChart"></canvas> <!-- Switched to Chart.js Bubble Chart for stability -->
                    </div>
                </div>

                <!-- 4. Risks by SOC 2 Category -->
                <div class="chart-card">
                    <h3>Risks by TSC Category</h3>
                    <div class="canvas-wrapper">
                        <canvas id="tscCategoryChart"></canvas>
                    </div>
                </div>

                <!-- 5. Risks by Owner -->
                <div class="chart-card">
                    <h3>Risks by Owner</h3>
                    <div class="canvas-wrapper">
                        <canvas id="ownerChart"></canvas>
                    </div>
                </div>

                <!-- 6. SOC 2 Control Coverage -->
                <div class="chart-card">
                    <h3>Control Coverage Progress</h3>
                    <div class="canvas-wrapper">
                        <canvas id="coverageChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Risk Heat Map -->

        <section class="risk-register-section">
            <div class="section-header">
                <h2>Risk Register</h2>
                <div class="section-actions">
                    <button class="btn btn-secondary btn-small" onclick="exportRisks('csv')">Export CSV</button>
                    <button class="btn btn-secondary btn-small" onclick="exportRisks('json')">Export JSON</button>
                    <button class="btn btn-secondary btn-small" onclick="exportRisks('pdf')">Export PDF</button>
                    <button class="btn btn-primary" onclick="openAddModal()">+ Add Risk</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Risk Name & Description</th>
                            <th>TSC Category</th>
                            <th style="text-align: center;">Likelihood</th>
                            <th style="text-align: center;">Impact</th>
                            <th style="text-align: center;">Score</th>
                            <th>Severity</th>
                            <th>Controls</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="risk-table-body">
                        <tr>
                            <td colspan="9" class="no-data">No risks found. Click "Add Risk" to get started.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Add/Edit Risk Modal -->
    <div id="risk-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Risk</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="risk-form" onsubmit="saveRisk(event)">
                <input type="hidden" id="risk-id">

                <div class="form-group">
                    <label for="risk-name">Risk Name *</label>
                    <input type="text" id="risk-name" required placeholder="e.g., Data Breach">
                </div>

                <div class="form-group">
                    <label for="risk-description">Description</label>
                    <textarea id="risk-description" rows="3" placeholder="Detailed description of the risk"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-likelihood">Likelihood (1-5) *</label>
                        <input type="number" id="risk-likelihood" min="1" max="5" required value="3">
                    </div>

                    <div class="form-group">
                        <label for="risk-impact">Impact (1-5) *</label>
                        <input type="number" id="risk-impact" min="1" max="5" required value="3">
                    </div>
                </div>

                <div class="form-group">
                    <input type="hidden" id="risk-framework" value="soc2">
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-primary);">Risk Treatment &
                    Remediation</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-treatment">Treatment Strategy</label>
                        <select id="risk-treatment">
                            <option value="Mitigate">Mitigate</option>
                            <option value="Accept">Accept</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Avoid">Avoid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="risk-status">Status</label>
                        <select id="risk-status">
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Mitigated">Mitigated</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="risk-action-items">Action Items</label>
                    <textarea id="risk-action-items" rows="2"
                        placeholder="Specific steps to address this risk"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="risk-owner">Owner</label>
                        <input type="text" id="risk-owner" placeholder="Person/team responsible">
                    </div>

                    <div class="form-group">
                        <label for="risk-due-date">Due Date</label>
                        <input type="date" id="risk-due-date">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Risk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Update current date in header
        function updateDate() {
            const dateEl = document.getElementById('current-date');
            if (dateEl) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateEl.textContent = new Date().toLocaleDateString('en-US', options);
            }
        }
        updateDate();

        // Dark Mode Toggle
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme') || 'light';

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }
        initTheme();
    </script>
</body>

</html>